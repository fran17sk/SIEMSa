{% extends 'contratos/home.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.container#cards {
    max-width: 1200px;
    margin:  auto;
    background: #ffffff;
    padding: 2rem;
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
}

/* Título */
.container#cards h1 {
    margin-bottom: 2rem;
    font-weight: 700;
    font-size: 1.8rem;
    color: #111827;
    text-align: center;
}

/* ==============================
   ESTRUCTURA DE FILAS (PROLIJA)
============================== */

/* Usamos un selector específico para tus filas */
.form-row {
    display: flex;
    flex-wrap: nowrap; /* Mantiene la distribución horizontal */
    gap: 20px;
    margin-bottom: 20px;
    align-items: flex-end; /* Alinea etiquetas y campos por la base */
    width: 100%;
}

/* Ajuste de ancho de columnas dentro de las filas */
.form-row .form-group {
    flex: 1; 
    display: flex;
    flex-direction: column;
    min-width: 0; /* Evita que el flexbox se desborde */
}

/* Casos especiales de ancho */
.form-row .form-group.full-width {
    flex: 2;
}

/* ==============================
   ELEMENTOS DEL FORMULARIO
============================== */

.form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #4b5563;
    font-size: 0.9rem;
    white-space: nowrap;
}

/* Estandarización de altura para que todo esté alineado */
.form-group input, 
.form-group select, 
.form-group textarea, 
.form-group .empresa-selected {
    height: 40px; 
    padding: 8px 12px;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background-color: #fff;
    box-sizing: border-box; /* Fundamental para que el padding no sume al ancho */
    width: 100%;
}

.form-group textarea {
    height: auto;
    min-height: 80px;
}

/* Estados de Focus y Deshabilitado */
.form-group input:focus, 
.form-group select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    outline: none;
}

.form-group input:disabled, 
.form-group select:disabled {
    background-color: #f3f4f6;
    color: #6b7280;
    cursor: not-allowed;
}

/* ==============================
   EXPEDIENTE CON ICONO (CORREGIDO)
============================== */

.input-with-icon {
    display: flex;
    align-items: center;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    background: #fff;
    height: 40px;
    overflow: hidden;
}

.input-with-icon input {
    border: none !important; /* Quita el borde interno */
    height: 100% !important;
    margin: 0 !important;
    box-shadow: none !important;
}

.estado-icon {
    padding: 0 10px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 35px;
}

/* ==============================
   CHECKBOXES (ALINEACIÓN CENTRADA)
============================== */

.form-group .checkbox-label {
    display: flex;
    align-items: center;
    height: 40px; /* Misma altura que los inputs para que se vea prolijo */
    margin-bottom: 0;
    cursor: pointer;
    font-weight: 600;
    color: #4b5563;
}

.form-group .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 10px;
    cursor: pointer;
}

/* ==============================
   DROPDOWN EMPRESA (PROLIJO)
============================== */

.empresa-dropdown {
    position: relative;
    width: 100%;
}

.empresa-selected {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.empresa-panel {
    display: none;
    position: absolute;
    top: 45px;
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 10px 15px rgba(0,0,0,0.1);
}

.empresa-panel ul {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 200px;
    overflow-y: auto;
}

.empresa-panel li {
    padding: 10px;
    cursor: pointer;
}

.empresa-panel li:hover {
    background: #f3f4f6;
}

/* ==============================
   BOTÓN Y ERRORES
============================== */

button[type="submit"] {
    display: block;
    margin: 30px auto 0;
    padding: 12px 40px;
    background: #2563eb;
    border: none;
    color: white;
    font-size: 1rem;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s;
}

button[type="submit"]:hover {
    background: #1e40af;
}

.error {
    color: #dc2626;
    font-size: 0.75rem;
    margin-top: 4px;
    height: 12px; /* Reserva el espacio para que no salte el layout */
}

/* ==============================
   RESPONSIVE
============================== */

@media (max-width: 992px) {
    .form-row {
        flex-wrap: wrap;
    }
    .form-row .form-group {
        flex: 1 1 45%; /* Dos columnas en tablets */
    }
}

@media (max-width: 600px) {
    .form-row .form-group {
        flex: 1 1 100%; /* Una columna en móviles */
    }
}
/* ==============================
   CARD DE INFO DE REGISTRO
============================== */
.registro-info {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin: 20px auto;
    padding: 12px 20px;
    background-color: #f8fafc; /* Azul grisáceo muy claro */
    border: 1px dashed #cbd5e1;
    border-radius: 10px;
    max-width: fit-content; /* Se ajusta al contenido */
}

.info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #64748b;
}

.info-item i {
    color: #2563eb;
    font-size: 1rem;
}

.info-item strong {
    color: #334155;
}

/* ==============================
   ESTILO PARA ADJUNTAR ARCHIVO
============================== */
.file-upload-wrapper {
    position: relative;
    width: 100%;
    margin-top: 8px;
}

/* Ocultamos el input real pero lo mantenemos funcional */
.file-upload-wrapper input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

/* La "caja" visual */
.file-upload-design {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px;
    border: 2px dashed #d1d5db;
    border-radius: 10px;
    background-color: #f9fafb;
    transition: all 0.3s ease;
    text-align: center;
}

.file-upload-design i {
    font-size: 1.4rem;
    color: #2563eb;
}

.file-upload-text {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
}

.file-name-display {
    display: block;
    margin-top: 8px;
    font-size: 0.85rem;
    color: #2563eb;
    font-weight: 600;
    font-style: italic;
}

/* Efectos al pasar el mouse o arrastrar archivo */
.file-upload-wrapper:hover .file-upload-design {
    border-color: #2563eb;
    background-color: #eff6ff;
}

.file-upload-wrapper input[type="file"]:focus + .file-upload-design {
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container" id="cards">
  <h1>Registrar Contrato</h1>

  <form id="contratoForm" method="post" action="{% url 'create_new' %}" novalidate enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="form-row">
      <div class="form-group">
        <label for="nro_expediente">Nro Expediente</label>
        <div class="input-with-icon">
          <input type="text" id="nro_expediente" placeholder="Ej. 12345" />
          <span id="estado_expediente" class="estado-icon"></span>
        </div>
      </div>

      <div class="form-group">
        <label for="EstadoMina">Estado Expediente</label>
        <input id="EstadoMina" type="text" value="" disabled>
      </div>

      <div class="form-group">
        <label for="TipoMina">Tipo Expediente</label>
        <input id="label_nro_expediente" type="text" value="" disabled>
      </div>

      <div class="form-group">
        <label for="NombreMina">Nombre Expediente</label>
        <input id="info_expediente" type="text" value="" disabled>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <label>Relación Concesionario</label>
        <div class="empresa-dropdown" id="concesionarioDropdown">
          <div class="empresa-selected" id="concesionarioSelected">
            <span id="concesionarioText">Seleccione concesionario</span>
            <i class="fa fa-caret-down"></i>
          </div>
          <div class="empresa-panel" id="concesionarioPanel">
            <input type="text" id="concesionarioSearch" placeholder="Buscar..." autocomplete="off">
            <ul id="concesionarioList">
              {% for c in concesionarios %}
              <li data-id="{{ c.id }}">{{ c.concesionario }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <input type="hidden" id="relacion_id_concesionario">
      </div>
      
      <div class="form-group">
        <label for="tipo_contrato">Tipo de Contrato</label>
        <select id="tipo_contrato" name="tipo_contrato" required>
          <option value="">Seleccionar</option>
          {% for tipo in tipos_contrato %}
          <option value="{{ tipo.id }}">{{ tipo.contratos_nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
    <label>Mineral Explotación</label>
    <div class="empresa-dropdown" id="mineralDropdown">
        <div class="empresa-selected" id="mineralSelected">
            <span id="mineralText">Seleccione mineral</span>
            <i class="fa fa-caret-down"></i>
        </div>
        <div class="empresa-panel" id="mineralPanel">
            <input type="text" id="mineralSearch" placeholder="Buscar mineral..." autocomplete="off" 
                   style="width: 100%; border: none; border-bottom: 1px solid #ddd; border-radius: 0;">
            <ul id="mineralList">
                {% for m in minerales %}
                <li data-value="{{ m.mineral }}">{{ m.mindet }} <small style="color: #9ca3af;">({{ m.mineral }})</small></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <input type="hidden" id="id_mineral_explotacion" name="mineral_explotacion">
</div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="pago_canon" name="pago_canon">
          Pago de Canon
        </label>
        <div class="error" id="error_pago_canon"></div>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="opcion_compra" name="opcion_compra">
          Opcion de Compra
        </label>
        <div class="error" id="error_opcion_compra"></div>
      </div>
      
      <div class="form-group">
        <label for="{{ form.fecha_ini.id_for_label }}">Fecha Inicio</label>
        {{ form.fecha_ini }}
      </div>

      <div class="form-group">
        <label for="{{ form.fecha_fin.id_for_label }}">Fecha Fin</label>
        {{ form.fecha_fin }}
      </div>

      <div class="form-group">
        <label for="activo">Estado Vigencia</label>
        <select id="activo" name="activo" disabled>
          <option value="si" selected>Vigente</option>
          <option value="no">No Vigente</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="observaciones">Observaciones</label>
      <textarea id="observaciones" name="observaciones" rows="3" placeholder="Observaciones adicionales..."></textarea>
    </div>
  
    <div class="form-group full-width" style="margin-bottom: 25px;">
    <label for="file">Documento del Contrato</label>
    <div class="file-upload-wrapper">
        <input type="file" id="file" name="file" accept=".pdf,image/*" onchange="updateFileName(this)">
        <div class="file-upload-design">
            <i class="fa fa-cloud-upload"></i>
            <span class="file-upload-text" id="upload-label">Haga clic aquí o arrastre el archivo (PDF o Imagen)</span>
        </div>
    </div>
    <span id="file-name" class="file-name-display"></span>
    <div class="error" id="error_file"></div>
</div>
    <div class="registro-info">
      <div class="info-item">
        <i class="fa fa-calendar"></i>
        <span><strong>Fecha de registro:</strong> <span id="fecha-actual"></span></span>
      </div>
      <div class="info-item">
        <i class="fa fa-user-circle"></i>
        <span><strong>Creado por:</strong> {{ user.username|default:"Usuario Actual" }}</span>
      </div>
    </div>

    <div class="button-container">
      <button type="submit">Guardar Contrato</button>
    </div>
  </form>
</div>
{% endblock %}

{% block script %}
<script>
function updateFileName(input) {
    const fileNameDisplay = document.getElementById('file-name');
    const uploadLabel = document.getElementById('upload-label');
    
    if (input.files && input.files.length > 0) {
        const name = input.files[0].name;
        fileNameDisplay.textContent = "Archivo seleccionado: " + name;
        uploadLabel.textContent = "Cambiar archivo";
        
        // Cambiar estilo visual a éxito
        input.nextElementSibling.style.borderColor = "#10b981"; // Verde esmeralda
        input.nextElementSibling.style.backgroundColor = "#ecfdf5";
    } else {
        fileNameDisplay.textContent = "";
        uploadLabel.textContent = "Haga clic aquí o arrastre el archivo (PDF o Imagen)";
        input.nextElementSibling.style.borderColor = "#d1d5db";
        input.nextElementSibling.style.backgroundColor = "#f9fafb";
    }
}


  document.addEventListener('DOMContentLoaded', () => {
    const fechaSpan = document.getElementById('fecha-actual');
    if (fechaSpan) {
        const hoy = new Date();
        const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
        fechaSpan.textContent = hoy.toLocaleDateString('es-ES', opciones);
    }
});
  const dropdownC = document.getElementById('concesionarioDropdown');
  const selectedC = document.getElementById('concesionarioSelected');
  const panelC = document.getElementById('concesionarioPanel');
  const searchC = document.getElementById('concesionarioSearch');
  const listC = document.getElementById('concesionarioList');
  const textC = document.getElementById('concesionarioText');
  const hiddenC = document.getElementById('relacion_id_concesionario');

  selectedC.addEventListener('click', () => {
    panelC.style.display = panelC.style.display === 'block' ? 'none' : 'block';
    searchC.value = '';
    searchC.focus();
    listC.querySelectorAll('li').forEach(li => li.style.display = '');
  });

  searchC.addEventListener('input', () => {
    const q = searchC.value.toLowerCase();
    listC.querySelectorAll('li').forEach(li => {
      li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  listC.addEventListener('click', e => {
    if (e.target.tagName === 'LI') {
      textC.textContent = e.target.textContent;
      hiddenC.value = e.target.dataset.id;
      panelC.style.display = 'none';
    }
  });

  document.addEventListener('click', e => {
    if (!dropdownC.contains(e.target)) {
      panelC.style.display = 'none';
    }
  });

  const dropdownM = document.getElementById('mineralDropdown');
const selectedM = document.getElementById('mineralSelected');
const panelM = document.getElementById('mineralPanel');
const searchM = document.getElementById('mineralSearch');
const listM = document.getElementById('mineralList');
const textM = document.getElementById('mineralText');
const hiddenM = document.getElementById('id_mineral_explotacion');

// Abrir/Cerrar panel
selectedM.addEventListener('click', () => {
    panelM.style.display = panelM.style.display === 'block' ? 'none' : 'block';
    searchM.value = '';
    searchM.focus();
    listM.querySelectorAll('li').forEach(li => li.style.display = '');
});

// Filtrado en tiempo real
searchM.addEventListener('input', () => {
    const q = searchM.value.toLowerCase();
    listM.querySelectorAll('li').forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
});

// Selección de elemento
listM.addEventListener('click', e => {
    const li = e.target.closest('li'); // Usa closest por si hacen clic en el <small>
    if (li) {
        textM.textContent = li.dataset.value;
        hiddenM.value = li.dataset.value;
        panelM.style.display = 'none';
    }
});

// Cerrar si se hace clic fuera (Generalizado)
document.addEventListener('click', e => {
    if (!dropdownM.contains(e.target)) panelM.style.display = 'none';
    if (!dropdownC.contains(e.target)) panelC.style.display = 'none'; // Concesionario
});
</script>
<script>
  const abrirModalBtn = document.getElementById('abrirModal');
  const modal = document.getElementById('buscarModal');
  const cerrarModalBtn = document.getElementById('cerrarModal');
  const searchInput = document.getElementById('searchInput');
  const resultados = document.getElementById('resultados');
  const selectConcesionario = document.getElementById('relacion_id_concesionario');

  abrirModalBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    searchInput.value = '';
    searchInput.focus()
    filterList('');
  });

  cerrarModalBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  // Cierra si clic fuera del modal
  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });

  // Filtro dinámico
  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    filterList(term);
  });

  function filterList(term) {
    const items = resultados.querySelectorAll('.result-item');
    items.forEach(item => {
      const texto = item.textContent.toLowerCase();
      item.style.display = texto.includes(term) ? 'flex' : 'none';
    });
  }

  // Elegir botón
  resultados.addEventListener('click', function (e) {
    if (e.target.classList.contains('elegir-btn')) {
      const item = e.target.closest('.result-item');
      const id = item.dataset.id;
      const nombre = item.firstChild.textContent.trim();

      selectConcesionario.value = id;
      modal.style.display = 'none';
    }
  });
</script>


<script>
  const formulario = document.getElementById('contratoForm').reset()
  const fechaIniInput = document.getElementById("{{ form.fecha_ini.id_for_label }}");
  const fechaFinInput = document.getElementById("{{ form.fecha_fin.id_for_label }}");
  const estadoSelect = document.getElementById("activo");

  function actualizarEstado() {
    const fechaIni = new Date(fechaIniInput.value);
    const fechaFin = new Date(fechaFinInput.value);
    const hoy = new Date();

    if (fechaIni && fechaFin && !isNaN(fechaIni) && !isNaN(fechaFin)) {
      if (fechaIni <= hoy && hoy <= fechaFin) {
        estadoSelect.value = "si";  // Activo
      } else {
        estadoSelect.value = "no";  // Caducado
      }
    } else {
      estadoSelect.value = "";
    }
  }

  fechaIniInput.addEventListener('change', actualizarEstado);
  fechaFinInput.addEventListener('change', actualizarEstado);


  document.getElementById('contratoForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const form = e.target;

  const nroExpediente = document.getElementById('nro_expediente').value.trim();
  const concesionarioText = document.getElementById('concesionarioText').textContent;
  const tipoContratoText = document.getElementById('tipo_contrato').selectedOptions[0]?.text || '';
  const fechaIni = document.getElementById('id_fecha_ini').value || '—';
  const fechaFin = document.getElementById('id_fecha_fin').value || '—';

  const concesionario = document.getElementById('relacion_id_concesionario').value.trim();
  let estado = document.getElementById('activo').value.trim();

  if (!nroExpediente || !concesionario) {
    Swal.fire({
      icon: 'warning',
      title: 'Faltan campos obligatorios',
      text: 'Debe completar: N° Expediente y Concesionario.'
    });
    return;
  }

  if (!fechaIni || !fechaFin) {
    estado = 'si';
  }

  /* ============================
     CONFIRMACIÓN CON RESUMEN
  ============================ */
  const confirmacion = await Swal.fire({
    title: '¿Confirmar creación del contrato?',
    icon: 'question',
    html: `
      <div style="text-align:left; font-size:14px">
        <p><strong>Expediente:</strong> ${nroExpediente}</p>
        <p><strong>Concesionario:</strong> ${concesionarioText}</p>
        <p><strong>Tipo de contrato:</strong> ${tipoContratoText}</p>
        <p><strong>Fecha inicio:</strong> ${fechaIni}</p>
        <p><strong>Fecha fin:</strong> ${fechaFin}</p>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Sí, crear contrato',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#2563eb',
    cancelButtonColor: '#9ca3af'
  });

  if (!confirmacion.isConfirmed) {
    return; // Usuario canceló
  }

  /* ============================
     ENVÍO REAL DEL FORMULARIO
  ============================ */
  const formData = new FormData();

// 2. Agregamos los campos de texto
formData.append('relacion_id_concesionario', concesionario);
formData.append('nro_expediente', nroExpediente);
formData.append('tipo_contrato', document.getElementById('tipo_contrato').value);
formData.append('pago_canon', document.getElementById('pago_canon').checked);
formData.append('opcion_compra', document.getElementById('opcion_compra').checked);
formData.append('mineral_explotacion', document.getElementById('id_mineral_explotacion').value);
formData.append('activo', estado);
formData.append('fecha_ini', fechaIni);
formData.append('fecha_fin', fechaFin);
formData.append('observaciones', document.getElementById('observaciones').value.trim());

// 3. AGREGAMOS EL ARCHIVO
const fileInput = document.getElementById('file');
if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
}

try {
    const response = await fetch(form.action, {
        method: 'POST',
        headers: {
            // IMPORTANTE: Al usar FormData, NO debes poner 'Content-Type': 'application/json'
            // El navegador lo pondrá automáticamente con el "boundary" correcto.
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData // Enviamos el objeto FormData directamente
    });

    const result = await response.json();

    if (response.ok) {
        // Notificación de Éxito tipo Toast
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: '¡Contrato creado con éxito!',
            showConfirmButton: false,
            timer: 4000,
            timerProgressBar: true
        });
        form.reset();
        // Opcional: limpiar iconos de validación y textos de expediente
        document.getElementById('estado_expediente').innerHTML = '';
        document.getElementById('info_expediente').value = '';
    } else {
        // Notificación de Error tipo Toast
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'warning',
            title: 'Error',
            text: result.error || 'Algo salió mal.',
            showConfirmButton: false,
            timer: 5000
        });
    }

  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error de conexión',
      text: 'No se pudo contactar con el servidor.'
    });
  }
});

  // Función para obtener el CSRF token desde la cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>


<script>
  const nroExpedienteInput = document.getElementById('nro_expediente');
  const p = document.getElementById('estado_expediente');
  const pl = document.getElementById('EstadoMina');
  const info = document.getElementById('info_expediente');
  const tipo = document.getElementById('label_nro_expediente');
  //const minerales = document.getElementById('minerals_declarated');

  nroExpedienteInput.addEventListener('input', async (e) => {
    // 1. Limpiar caracteres no numéricos
    e.target.value = e.target.value.replace(/\D/g, '');
    const nro = e.target.value;

    // 2. Si está vacío, resetear TODO inmediatamente
    if (nro.length < 1) {
      p.innerHTML = '';
      p.title = '-';
      info.value = '';
      pl.value = '';
      tipo.value = 'Nro Expediente'; // Asumiendo que es un Label
      return;
    }

    try {
      p.innerHTML = '<i class="fa fa-spinner fa-spin" style="color: #888;"></i>';
      p.title = 'Verificando...';

      const response = await fetch(`/verificar-expediente/${nro}/`);

      if (response.status === 200 || response.status === 300) {
        const expediente = await response.json();

        // Determinar estado según el status code
        if (response.status === 200) {
          p.innerHTML = '<i class="fa fa-check-circle" style="color: green;"></i>';
          p.title = 'Vigente';
        } else {
          p.innerHTML = '<i class="fa fa-archive" style="color: orange;"></i>';
          p.title = 'Archivado';
        }

        // ACTUALIZACIÓN DE CAMPOS
        info.value = expediente.nombre;
        tipo.value = expediente.tipo; // Cambiado a innerText por seguridad
        pl.value = p.title; // Aquí se asigna "Vigente" o "Archivado" al input oculto
        //minerales.value = expediente.minerales

      } else {
        // 3. Si el número no existe, limpiar los datos anteriores
        p.innerHTML = '<i class="fa fa-times-circle" style="color: red;"></i>';
        p.title = 'No encontrado';
        tipo.value = 'No existe';
        info.value = ' - ';
        pl.value = 'No encontrado';
      }

    } catch (error) {
      console.error('Error:', error);
      p.innerHTML = '<i class="fa fa-exclamation-circle" style="color: red;"></i>';
      p.title = 'Error de conexión';
      info.value = 'Error al conectar';
      pl.value = 'Error';
    }
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock %}